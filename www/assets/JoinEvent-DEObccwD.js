import{ai as F,aD as M,r as I,u as Y,a as z,b as X,w as B,x as Q,s as C,d as _,j as t,ae as W,B as P,af as Z,C as ee,M as te,N as se,O as ne,f as ie,Q as ae,p as L,I as U,a3 as oe,aE as re}from"./index-PUmVADdG.js";import{c as ce,f as le,d as de}from"./validation-DjZNYcmo.js";import me from"./QRScanner-DI6B8mTI.js";const ve=()=>{var w;const{eventCode:E}=F(),[V]=M(),A=V.get("passcode"),[v,y]=I.useState(E||""),[O,b]=I.useState(A||""),[p,x]=I.useState(!1),[s,S]=I.useState(null),[k,R]=I.useState(!1),{user:e,isLoading:K}=Y(),{toast:d}=z(),N=X(),{dbPlatform:G,isNative:H}=B(),{createEventNotificationSettings:q}=Q(),J=((w=window.CapacitorPushNotifications)==null?void 0:w.getToken())||null;I.useEffect(()=>{console.log("ðŸ” AUTO EVENT CHECK TRIGGER:",{urlEventCode:E,hasUser:!!e,userId:e==null?void 0:e.id,userEmail:e==null?void 0:e.email,timestamp:new Date().toISOString()}),E&&e?(console.log("ðŸŽ¯ AUTO-CHECKING EVENT EXISTS:",E),D(E)):console.log("â¸ï¸ SKIPPING AUTO-CHECK:",{hasUrlEventCode:!!E,hasUser:!!e})},[E,e]),I.useEffect(()=>{(async()=>{if(!v&&!E||!e)return;e.email&&(e.email.includes("gmail.com")||e.email.includes("apple.com")||e.email.includes("icloud.com"))&&await new Promise(i=>setTimeout(i,1e3));const c=v||E;if(c){console.log("ðŸ” PARTICIPATION CHECK START:",{userId:e.id,code:c,userEmail:e.email,timestamp:new Date().toISOString()});try{const{data:i,error:n}=await C.from("invite_links").select("event_id").ilike("link",`%/join/${c}`).maybeSingle();if(console.log("ðŸ“§ INVITE LOOKUP RESULT:",{inviteData:i,inviteError:n,queryPattern:`%/join/${c}`,errorCode:n==null?void 0:n.code,errorMessage:n==null?void 0:n.message,foundInvite:!!i,eventId:i==null?void 0:i.event_id}),n){console.error("âŒ INVITE LOOKUP ERROR:",{error:n,code:n.code,message:n.message,details:n.details,hint:n.hint});return}if(!i){console.log("ðŸ“­ NO INVITE FOUND for code:",{codeToCheck:c,queryPattern:`%/join/${c}`,reason:"No matching invite link in database"});return}const{data:l,error:r}=await C.from("event_participants").select("event_id, roles, joined_at, user_id").eq("user_id",e.id).eq("event_id",i.event_id).maybeSingle();if(console.log("ðŸ‘¥ PARTICIPATION CHECK RESULT:",{participantData:l,participantError:r,eventId:i.event_id,userId:e.id,query:`user_id=${e.id} AND event_id=${i.event_id}`}),r){console.error("âŒ PARTICIPATION CHECK ERROR:",r);return}if(l){console.log("âœ… USER ALREADY PARTICIPANT - REDIRECTING:",{eventId:l.event_id,roles:l.roles||["guest"],joinedAt:l.joined_at,participantUserId:l.user_id,currentUserId:e.id}),d({title:"Welcome back!",description:"You're already part of this event."}),N(`/event/${l.event_id}`,{replace:!0});return}console.log("ðŸ†• USER NOT YET PARTICIPANT - CAN JOIN")}catch(i){console.error("ðŸ’¥ PARTICIPATION CHECK EXCEPTION:",{error:i,message:i==null?void 0:i.message,stack:i==null?void 0:i.stack,userId:e.id,code:c})}}})()},[v,E,e,N,d]),I.useEffect(()=>{if(s&&A&&!p&&e&&A===s.passcode){const o=new Event("submit");j(o)}},[s,A,p,e]);const D=async o=>{var c,i;try{console.log("ðŸ” CHECKING EVENT EXISTS:",{code:o,queryPattern:`%/join/${o}`,timestamp:new Date().toISOString()});const{data:n,error:l}=await C.from("invite_links").select("event_id, link").ilike("link",`%/join/${o}`).maybeSingle();if(l){console.error("âŒ EVENT LOOKUP - INVITE ERROR:",{error:l,code:l.code,message:l.message,details:l.details,hint:l.hint,queryCode:o}),S(null),d({title:"Error finding event",description:`Database error: ${l.message}`,variant:"destructive"});return}if(!n){console.log("âŒ EVENT LOOKUP - NO INVITE FOUND:",{code:o,queryPattern:`%/join/${o}`,reason:"No matching invite link in database"}),S(null),d({title:"Event not found",description:"Please check the event code and try again.",variant:"destructive"});return}const{data:r,error:u}=await C.from("events").select(`
          event_id,
          name,
          start_time,
          end_time,
          status,
          passcode,
          event_settings(custom_message)
        `).eq("event_id",n.event_id).maybeSingle();if(console.log("ðŸ“… EVENT LOOKUP RESULT:",{inviteData:n,eventData:r,error:l||u,queryPattern:`%/join/${o}`}),u){console.error("âŒ EVENT LOOKUP - EVENT DATA ERROR:",{error:u,code:u.code,message:u.message,details:u.details,hint:u.hint,eventId:n.event_id}),S(null),d({title:"Error finding event",description:`Database error: ${u.message}`,variant:"destructive"});return}if(!r){console.log("âŒ EVENT LOOKUP - NO EVENT DATA:",{code:o,eventId:n.event_id,reason:"Event not found in events table"}),S(null),d({title:"Event not found",description:"Please check the event code and try again.",variant:"destructive"});return}const m=r,g=new Date,a=new Date(m.start_time),T=new Date(m.end_time),f=g>=a&&g<=T;console.log("â° EVENT TIMING ANALYSIS:",{eventId:m.event_id,eventName:m.name,now:g.toISOString(),startTime:a.toISOString(),endTime:T.toISOString(),isActive:f,timeUntilStart:a>g?a.getTime()-g.getTime():"already started",timeUntilEnd:T>g?T.getTime()-g.getTime():"already ended",requiresPasscode:!!m.passcode});const h={id:m.event_id,name:m.name,description:((i=(c=m.event_settings)==null?void 0:c[0])==null?void 0:i.custom_message)||"",requiresPasscode:!!m.passcode,passcode:m.passcode,isActive:f,startTime:m.start_time,endTime:m.end_time};console.log("âœ… EVENT FOUND AND FORMATTED:",{eventId:h.id,name:h.name,isActive:h.isActive,requiresPasscode:h.requiresPasscode,hasDescription:!!h.description}),S(h),f||(console.log("âš ï¸ EVENT NOT ACTIVE - SHOWING WARNING"),d({title:"Event not active",description:"This event is not currently accepting photos.",variant:"destructive"}))}catch(n){console.error("ðŸ’¥ EVENT CHECK EXCEPTION:",{error:n,message:n==null?void 0:n.message,stack:n==null?void 0:n.stack,code:o,timestamp:new Date().toISOString()}),d({title:"Connection error",description:"Unable to verify event. Please try again.",variant:"destructive"})}},j=async o=>{var i,n,l;if(o.preventDefault(),console.log("ðŸš€ JOIN EVENT TRIGGERED:",{isJoining:p,eventCode:v,hasEvent:!!s,eventId:s==null?void 0:s.id,hasUser:!!e,userId:e==null?void 0:e.id,userEmail:e==null?void 0:e.email,requiresPasscode:s==null?void 0:s.requiresPasscode,hasPasscode:!!O,timestamp:new Date().toISOString()}),p){console.log("ðŸ›‘ JOIN ALREADY IN PROGRESS - IGNORING DUPLICATE SUBMISSION");return}if(console.log("â±ï¸ CHECKING RATE LIMIT..."),!ce("join_event",10,3e5)){console.log("âŒ RATE LIMIT EXCEEDED"),d({title:"Too many attempts",description:"Please wait before trying to join again.",variant:"destructive"});return}console.log("âœ… RATE LIMIT CHECK PASSED"),console.log("ðŸ” VALIDATING EVENT CODE:",v);const c=le(v);if(console.log("ðŸ“ EVENT CODE VALIDATION RESULT:",{original:v,sanitized:c.sanitized,isValid:c.isValid,error:c.error}),!c.isValid){console.log("âŒ INVALID EVENT CODE"),d({title:"Invalid event code",description:c.error,variant:"destructive"});return}if(!s){console.log("ðŸ“‹ NO EVENT LOADED - CHECKING EVENT EXISTS..."),await D(c.sanitized);return}if(!e){console.log("âŒ NO USER AUTHENTICATED"),d({title:"Authentication required",description:"Please sign in to join events.",variant:"destructive"});return}x(!0),console.log("ðŸ”’ JOIN PROCESS STARTED - LOCKING UI");try{console.log("ðŸ” VALIDATING PASSCODE...");const r=de(O);if(console.log("ðŸ”‘ PASSCODE VALIDATION RESULT:",{hasPasscode:!!O,isValid:r.isValid,error:r.error}),!r.isValid){console.log("âŒ INVALID PASSCODE FORMAT"),d({title:"Invalid passcode format",description:r.error,variant:"destructive"}),x(!1);return}if(console.log("ðŸ” CHECKING PASSCODE MATCH..."),r.sanitized!==s.passcode){console.log("âŒ PASSCODE MISMATCH:",{provided:r.sanitized,expected:s.passcode}),d({title:"Incorrect passcode",description:"Please enter the correct event passcode.",variant:"destructive"}),x(!1);return}console.log("âœ… PASSCODE VALIDATED"),console.log("ðŸ”„ FINAL PARTICIPATION CHECK before insert");const{data:u,error:m}=await C.from("event_participants").select("event_id, roles, joined_at").eq("user_id",e.id).eq("event_id",s.id).maybeSingle();if(console.log("ðŸ” FINAL PARTICIPATION CHECK RESULT:",{finalParticipantCheck:u,finalCheckError:m,alreadyParticipant:!!u}),m&&console.error("âŒ FINAL PARTICIPATION CHECK ERROR:",m),u){console.log("ðŸš¨ USER ALREADY PARTICIPANT - DETECTED DURING JOIN:",u),d({title:"Already joined!",description:"You're already part of this event. Redirecting to the gallery..."}),N(`/event/${s.id}`,{replace:!0});return}console.log("ðŸš€ ATTEMPTING TO JOIN EVENT:",{eventId:s.id,userId:e.id,userEmail:e.email,eventName:s.name,timestamp:new Date().toISOString(),isSSO:e.email&&(e.email.includes("gmail.com")||e.email.includes("apple.com")||e.email.includes("icloud.com"))}),console.log("ðŸ“¤ INSERTING PARTICIPANT RECORD...");const g={event_id:s.id,user_id:e.id,roles:["guest"],joined_at:new Date().toISOString(),is_blocked:!1};console.log("ðŸ“ PARTICIPANT INSERT DATA:",g);const{error:a}=await C.from("event_participants").insert(g);if(console.log("ðŸ’¾ JOIN EVENT RESULT:",{participantError:a,errorCode:a==null?void 0:a.code,errorMessage:a==null?void 0:a.message,errorDetails:a==null?void 0:a.details}),a){if(console.error("âŒ FAILED TO JOIN EVENT:",a),a.code==="23505"||(i=a.message)!=null&&i.includes("duplicate")||(n=a.message)!=null&&n.includes("already exists")||(l=a.message)!=null&&l.includes("unique constraint")){console.log("ðŸ”„ DUPLICATE PARTICIPANT DETECTED - REDIRECTING"),d({title:"Already joined!",description:"You're already part of this event. Redirecting to the gallery..."}),N(`/event/${s.id}`,{replace:!0});return}console.error("ðŸ’€ UNKNOWN JOIN ERROR:",{code:a.code,message:a.message,details:a.details,hint:a.hint}),d({title:"Join failed",description:`Unable to join the event: ${a.message}`,variant:"destructive"});return}if(console.log("âœ… SUCCESSFULLY JOINED EVENT"),d({title:"Welcome to the event!",description:`You're now connected to ${_(s.name)}. Start taking photos!`}),N(`/event/${s.id}`,{replace:!0}),H&&J)try{console.log("ðŸ”” Auto-registering participant for notifications");const T={eventId:s.id,eventName:s.name,eventStartTime:s.startTime,eventEndTime:s.endTime,eventDeleteDate:new Date(new Date(s.endTime).getTime()+s.retentionDays*24*60*60*1e3).toISOString(),platform:G,preferences:{upcomingEvent:!0,eventStarting:!0,uploadReminder:!0,downloadReminder:!0}};console.log("ðŸ”” Setting up notifications for new participant");const f=await q(s.id,{upcomingEvent:!0,eventStarting:!0,uploadReminder:!0,downloadReminder:!0});f.success?console.log("âœ… Notification settings created for participant"):console.error("âŒ Failed to create notification settings:",f.error)}catch(T){console.error("âŒ Failed to auto-register participant for notifications:",T)}}catch(r){console.error("ðŸ’¥ JOIN EVENT EXCEPTION:",{error:r,message:r==null?void 0:r.message,stack:r==null?void 0:r.stack,eventId:s==null?void 0:s.id,userId:e==null?void 0:e.id,timestamp:new Date().toISOString()}),d({title:"Join failed",description:"Unable to join the event. Please try again.",variant:"destructive"})}finally{console.log("ðŸ”“ JOIN PROCESS COMPLETED - UNLOCKING UI"),x(!1)}},$=async(o,c)=>{console.log("ðŸ” QR SCAN RESULT:",{scannedEventCode:o,scannedPasscode:c}),y(o),R(!1),await D(o),c&&(b(c),setTimeout(()=>{const i=document.createElement("form"),n=new Event("submit",{cancelable:!0,bubbles:!0});Object.defineProperty(n,"target",{value:i,enumerable:!0}),j(n)},100))};return K?t.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),t.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})}):t.jsxs(W,{children:[t.jsx("div",{className:"sticky top-0 z-40 bg-background/80 backdrop-blur-md border-b border-border",children:t.jsx("div",{className:"container mx-auto px-4 py-3",children:t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>N("/dashboard"),className:"gap-2",children:[t.jsx(Z,{className:"w-4 h-4"}),"Back"]})})})}),t.jsx("div",{className:"flex items-center justify-center p-4",children:t.jsx("div",{className:"w-full max-w-md space-y-6",children:t.jsxs(ee,{children:[t.jsxs(te,{children:[t.jsx(se,{children:"Join Event"}),t.jsx(ne,{children:"Enter the event code to get started"})]}),t.jsxs(ie,{className:"space-y-4",children:[t.jsxs(P,{variant:"outline",className:"w-full h-12 text-base gap-2",onClick:()=>R(!0),children:[t.jsx(ae,{className:"w-5 h-5"}),"Scan QR Code"]}),t.jsxs("div",{className:"relative my-4",children:[t.jsx("div",{className:"absolute inset-0 flex items-center",children:t.jsx("div",{className:"w-full border-t border-border"})}),t.jsx("div",{className:"relative flex justify-center text-sm",children:t.jsx("span",{className:"px-2 bg-card text-muted-foreground",children:"or enter manually"})})]}),t.jsxs("form",{onSubmit:j,className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(L,{htmlFor:"eventCode",children:"Event Code"}),t.jsx(U,{id:"eventCode",value:v,onChange:o=>y(o.target.value),placeholder:"AMAZINGPARTY42",className:"text-center text-lg font-mono uppercase"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(L,{htmlFor:"passcode",children:"Passcode"}),t.jsx(U,{id:"passcode",type:"password",value:O,onChange:o=>b(o.target.value),placeholder:"1234",maxLength:4,className:"text-center text-lg font-mono"})]}),s&&t.jsx("div",{className:"p-3 bg-primary/5 rounded-lg border border-primary/20",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(oe,{className:"h-5 w-5 text-primary mt-0.5"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm",children:_(s.name)}),t.jsx("p",{className:"text-xs text-muted-foreground",children:s.description}),!s.isActive&&t.jsxs("div",{className:"flex items-center space-x-1 mt-1",children:[t.jsx(re,{className:"h-3 w-3 text-orange-500"}),t.jsx("span",{className:"text-xs text-orange-600",children:"Event not currently active"})]})]})]})}),t.jsx(P,{type:"submit",className:"camera-button w-full h-12 text-base",disabled:p||s&&!s.isActive||!e,children:p?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2"}),"Joining..."]}):e?s?"Join Event":"Find Event":"Sign in to join"}),!e&&t.jsxs("p",{className:"text-xs text-center text-muted-foreground",children:[t.jsx(P,{type:"button",variant:"link",size:"sm",onClick:()=>N("/"),className:"h-auto p-0",children:"Sign in"})," ","to join events"]})]})]})]})})}),t.jsx(me,{isOpen:k,onClose:()=>R(!1),onScanResult:$})]})};export{ve as default};
