import{K as $,r as v,j as e,C as b,M as I,N as D,O as U,p as o,V as H,f as C,I as T,W as Y,X as F,Y as M,Z as R,$ as P,a0 as j,a1 as Q,B as E,a as X,s as g,a2 as A,h as J,a3 as G,a4 as z,U as re,a5 as le,S as K,a6 as ce,a7 as oe,a8 as W,a9 as O}from"./index-PUmVADdG.js";import{A as de,a as me}from"./alert-Df2vlNyC.js";import{T as V,S as ee}from"./trending-up-B9niBxyP.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=$("ChartColumn",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=$("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=$("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=$("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),te=[{value:"event",label:"Event Details",description:"Navigate to event gallery/details screen",requiresEventId:!0},{value:"upload",label:"Upload Photos",description:"Navigate to photo upload flow",requiresEventId:!0},{value:"download",label:"Download Photos",description:"Navigate to bulk download screen",requiresEventId:!0},{value:"join",label:"Join Event",description:"Navigate to join screen with event code",requiresEventCode:!0},{value:"create",label:"Create Event",description:"Navigate to create new event screen",requiresEventId:!1},{value:"home",label:"Home/Dashboard",description:"Navigate to main app screen",requiresEventId:!1}],ve={upcoming_event:"Upcoming Event",event_starting:"Event Starting",upload_reminder:"Upload Photos",download_reminder:"Download Photos"},ge={upcoming_event:"Sent before event starts to remind users",event_starting:"Sent when event goes live",upload_reminder:"Sent after event ends to remind photo uploads",download_reminder:"Sent before photos are auto-deleted"},pe=({template:a,onUpdate:x})=>{const[h,f]=v.useState({title:a.title,body:a.body,timing_value:a.timing_value,timing_unit:a.timing_unit,is_active:a.is_active,deep_link_type:a.deep_link_type||"event"}),[y,d]=v.useState(!1),[n,c]=v.useState(!1),r=(l,p)=>{f(L=>({...L,[l]:p})),c(!0)},u=async()=>{d(!0);try{await x(a.id,h),c(!1)}finally{d(!1)}},t=ve[a.template_type],i=ge[a.template_type];return e.jsxs(b,{className:"w-full",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(D,{className:"text-lg",children:t}),e.jsx(U,{children:i})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(o,{htmlFor:`active-${a.id}`,className:"text-sm",children:"Active"}),e.jsx(H,{id:`active-${a.id}`,checked:h.is_active,onCheckedChange:l=>r("is_active",l)})]})]})}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:`title-${a.id}`,children:"Title"}),e.jsx(T,{id:`title-${a.id}`,value:h.title,onChange:l=>r("title",l.target.value),placeholder:"Notification title"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:`body-${a.id}`,children:"Body Message"}),e.jsx(Y,{id:`body-${a.id}`,value:h.body,onChange:l=>r("body",l.target.value),placeholder:"Notification message body",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:`deep-link-${a.id}`,className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Deep Link Destination"]}),e.jsxs(F,{value:h.deep_link_type,onValueChange:l=>r("deep_link_type",l),children:[e.jsx(M,{id:`deep-link-${a.id}`,children:e.jsx(R,{})}),e.jsx(P,{children:te.map(l=>e.jsx(j,{value:l.value,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:l.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:l.description})]})},l.value))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:`timing-value-${a.id}`,children:"Timing Value"}),e.jsx(T,{id:`timing-value-${a.id}`,type:"number",min:"0",value:h.timing_value,onChange:l=>r("timing_value",parseInt(l.target.value)||0)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:`timing-unit-${a.id}`,children:"Timing Unit"}),e.jsxs(F,{value:h.timing_unit,onValueChange:l=>r("timing_unit",l),children:[e.jsx(M,{id:`timing-unit-${a.id}`,children:e.jsx(R,{})}),e.jsxs(P,{children:[e.jsx(j,{value:"minutes",children:"Minutes"}),e.jsx(j,{value:"hours",children:"Hours"}),e.jsx(j,{value:"days",children:"Days"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsxs("span",{children:["Trigger: ",h.timing_value," ",h.timing_unit," ",a.template_type==="upcoming_event"?"before event starts":a.template_type==="event_starting"?"when event starts":a.template_type==="upload_reminder"?"after event ends":"before auto-delete"]})]}),e.jsxs("div",{className:"bg-muted/50 p-3 rounded-md",children:[e.jsx(o,{className:"text-sm font-medium",children:"Available Placeholders:"}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:[e.jsx("code",{children:"{{event_title}}"}),", ",e.jsx("code",{children:"{{event_start_date}}"}),", ",e.jsx("code",{children:"{{event_end_date}}"}),", ",e.jsx("code",{children:"{{auto_delete_date}}"})]})]}),n&&e.jsxs(E,{onClick:u,disabled:y,className:"w-full",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),y?"Saving...":"Save Changes"]})]})]})},je=()=>{const[a,x]=v.useState([]),[h,f]=v.useState(!1),{toast:y}=X(),d=async()=>{f(!0);try{const{data:c,error:r}=await g.from("notification_templates").select("*").order("template_type");if(r)throw r;x(c||[])}catch(c){console.error("Error fetching notification templates:",c),y({title:"Error",description:"Failed to load notification templates",variant:"destructive"})}finally{f(!1)}},n=async(c,r)=>{try{const{error:u}=await g.from("notification_templates").update(r).eq("id",c);if(u)throw u;x(t=>t.map(i=>i.id===c?{...i,...r}:i)),y({title:"Success",description:"Notification template updated successfully"})}catch(u){console.error("Error updating notification template:",u),y({title:"Error",description:"Failed to update notification template",variant:"destructive"})}};return v.useEffect(()=>{d()},[]),{templates:a,loading:h,updateTemplate:n,refetchTemplates:d}},fe=()=>{const{templates:a,loading:x,updateTemplate:h}=je();return x?e.jsx("div",{className:"space-y-6",children:[1,2,3,4].map(f=>e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsx(A,{className:"h-6 w-48"}),e.jsx(A,{className:"h-4 w-64"})]}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(A,{className:"h-10 w-full"}),e.jsx(A,{className:"h-24 w-full"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(A,{className:"h-10 w-full"}),e.jsx(A,{className:"h-10 w-full"})]})]})})]},f))}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5"}),"Global Notification Templates"]}),e.jsx(U,{children:"Configure automated push notifications sent to all events. Users receive notifications only for types they've opted into."})]}),e.jsx(C,{children:e.jsxs(de,{children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsxs(me,{children:["These templates apply to all events automatically. Notifications are only sent to users who have opted into each notification type for their events. The system uses the ",e.jsx("code",{children:"user_event_notification_settings"})," table to check user preferences."]})]})})]}),e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsx(D,{className:"text-lg",children:"Available Dynamic Placeholders"}),e.jsx(U,{children:"Use these placeholders in your notification titles and bodies. They will be automatically replaced with event-specific data when notifications are sent."})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm font-mono",children:"{{event_title}}"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"The name of the event"})]}),e.jsxs("div",{children:[e.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm font-mono",children:"{{event_start_date}}"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"When the event starts (formatted date)"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm font-mono",children:"{{event_end_date}}"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"When the event ends (formatted date)"})]}),e.jsxs("div",{children:[e.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm font-mono",children:"{{auto_delete_date}}"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"When photos will be automatically deleted"})]})]})]}),e.jsx("div",{className:"mt-4 p-3 bg-muted/50 rounded-md",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Firebase Configuration:"})," Notifications will use event URL (event/","{{event_id}}",") for click_action, QR code image as icon (app icon fallback), and header image if available."]})})]})]}),e.jsx("div",{className:"grid gap-6",children:a.map(f=>e.jsx(pe,{template:f,onUpdate:h},f.id))}),a.length===0&&!x&&e.jsx(b,{children:e.jsx(C,{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(J,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium",children:"No Templates Found"}),e.jsx("p",{className:"text-muted-foreground",children:"No notification templates have been configured yet."})]})})})]})},Ne=()=>{const[a,x]=v.useState({totalCampaigns:0,activeCampaigns:0,totalSent:0,totalDelivered:0,totalOpened:0,deliveryRate:0,openRate:0}),[h,f]=v.useState(!0),y=async()=>{try{const{data:n,error:c}=await g.from("push_campaigns").select("status, total_sent, total_delivered, total_opened");if(c)throw c;const r=(n==null?void 0:n.length)||0,u=(n==null?void 0:n.filter(w=>w.status==="active").length)||0,t=(n==null?void 0:n.reduce((w,S)=>w+(S.total_sent||0),0))||0,i=(n==null?void 0:n.reduce((w,S)=>w+(S.total_delivered||0),0))||0,l=(n==null?void 0:n.reduce((w,S)=>w+(S.total_opened||0),0))||0,p=t>0?i/t*100:0,L=i>0?l/i*100:0;x({totalCampaigns:r,activeCampaigns:u,totalSent:t,totalDelivered:i,totalOpened:l,deliveryRate:p,openRate:L})}catch(n){console.error("Error fetching analytics:",n),le.error("Failed to load analytics")}finally{f(!1)}};if(v.useEffect(()=>{y()},[]),h)return e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[...Array(8)].map((n,c)=>e.jsxs(b,{className:"animate-pulse",children:[e.jsx(I,{className:"pb-2",children:e.jsx("div",{className:"h-4 bg-muted rounded w-1/2"})}),e.jsx(C,{children:e.jsx("div",{className:"h-8 bg-muted rounded w-3/4"})})]},c))});const d=({title:n,value:c,icon:r,description:u,isPercentage:t=!1})=>e.jsxs(b,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(D,{className:"text-sm font-medium",children:n}),e.jsx(r,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t?`${c.toFixed(1)}%`:c.toLocaleString()}),u&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:u})]})]});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(d,{title:"Total Campaigns",value:a.totalCampaigns,icon:V,description:"All campaigns created"}),e.jsx(d,{title:"Active Campaigns",value:a.activeCampaigns,icon:Q,description:"Currently running"}),e.jsx(d,{title:"Total Sent",value:a.totalSent,icon:ee,description:"Notifications sent"}),e.jsx(d,{title:"Total Delivered",value:a.totalDelivered,icon:G,description:"Successfully delivered"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[e.jsx(d,{title:"Total Opened",value:a.totalOpened,icon:z,description:"Users who opened notifications"}),e.jsx(d,{title:"Delivery Rate",value:a.deliveryRate,icon:G,description:"% of sent notifications delivered",isPercentage:!0}),e.jsx(d,{title:"Open Rate",value:a.openRate,icon:z,description:"% of delivered notifications opened",isPercentage:!0})]}),e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsx(D,{children:"Performance Insights"}),e.jsx(U,{children:"Key metrics and recommendations for your campaigns"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Delivery Performance"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:a.deliveryRate>=90?e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(G,{className:"h-4 w-4"}),"Excellent delivery rate (",a.deliveryRate.toFixed(1),"%)"]}):a.deliveryRate>=70?e.jsxs("div",{className:"flex items-center gap-2 text-yellow-600",children:[e.jsx(Q,{className:"h-4 w-4"}),"Good delivery rate (",a.deliveryRate.toFixed(1),"%)"]}):e.jsxs("div",{className:"flex items-center gap-2 text-red-600",children:[e.jsx(V,{className:"h-4 w-4"}),"Delivery rate needs improvement (",a.deliveryRate.toFixed(1),"%)"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Engagement Performance"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:a.openRate>=25?e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(z,{className:"h-4 w-4"}),"Great engagement (",a.openRate.toFixed(1),"% open rate)"]}):a.openRate>=15?e.jsxs("div",{className:"flex items-center gap-2 text-yellow-600",children:[e.jsx(V,{className:"h-4 w-4"}),"Average engagement (",a.openRate.toFixed(1),"% open rate)"]}):e.jsxs("div",{className:"flex items-center gap-2 text-red-600",children:[e.jsx(re,{className:"h-4 w-4"}),"Low engagement (",a.openRate.toFixed(1),"% open rate)"]})})]})]}),a.totalSent===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(V,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Data Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Create and activate campaigns to see analytics data here."})]})]})]})]})},ye=()=>{const[a,x]=v.useState(!1);return{isLoading:a,registerFCMToken:async(d,n,c)=>{x(!0);try{console.log("ðŸ”” Registering FCM token:",{fcm_token:d.substring(0,20)+"...",platform:n,deviceId:c});const{data:{user:r},error:u}=await g.auth.getUser();if(u||!(r!=null&&r.id))throw console.error("âŒ Authentication issue:",{user:(r==null?void 0:r.id)||"none",authError:u}),new Error("User not properly authenticated. Please sign in again.");const{data:t}=await g.from("user_fcm_tokens").select("id").eq("user_id",r.id).eq("fcm_token",d).single();let i;if(t){const{data:l,error:p}=await g.from("user_fcm_tokens").update({platform:n,device_id:c,updated_at:new Date().toISOString()}).eq("user_id",r.id).eq("fcm_token",d).select();if(p)throw p;i=l}else{const{data:l,error:p}=await g.from("user_fcm_tokens").insert({user_id:r.id,fcm_token:d,platform:n,device_id:c}).select();if(p)throw p;i=l}return console.log("âœ… FCM token stored successfully:",i),{success:!0,data:i}}catch(r){return console.error("âŒ Failed to register FCM token:",r),{success:!1,error:r.message}}finally{x(!1)}},sendTestNotification:async(d,n,c,r,u,t)=>{x(!0);try{console.log("ðŸ“± Sending test Firebase notification");const i={...n,notificationType:"custom",customTitle:c||`Test notification for ${n.eventName}`,customBody:r||"This is a test notification to verify Firebase integration.",headerImage:u,qrCodeImage:t},{data:l,error:p}=await g.functions.invoke("send-firebase-notification",{body:{token:d,...i}});if(p)throw console.error("âŒ Error sending test notification:",p),p;return console.log("âœ… Test notification sent successfully:",l),{success:!0,data:l}}catch(i){return console.error("âŒ Failed to send test notification:",i),{success:!1,error:i.message}}finally{x(!1)}},removeFCMToken:async d=>{x(!0);try{console.log("ðŸ”• Removing FCM token:",d.substring(0,20)+"...");const{data:{user:n},error:c}=await g.auth.getUser();if(c||!(n!=null&&n.id))throw console.error("âŒ Authentication issue in remove token:",{user:(n==null?void 0:n.id)||"none",authError:c}),new Error("User not properly authenticated. Please sign in again.");const{error:r}=await g.from("user_fcm_tokens").delete().eq("user_id",n.id).eq("fcm_token",d);if(r)throw console.error("âŒ Error removing FCM token:",r),r;return console.log("âœ… FCM token removed successfully"),{success:!0}}catch(n){return console.error("âŒ Failed to remove FCM token:",n),{success:!1,error:n.message}}finally{x(!1)}}}},_e=()=>{const[a,x]=v.useState([]),[h,f]=v.useState(""),[y,d]=v.useState([]),[n,c]=v.useState(""),[r,u]=v.useState(!1),[t,i]=v.useState({eventId:"test-event-"+Date.now(),eventName:"Test Event",eventStartTime:new Date().toISOString(),eventEndTime:new Date(Date.now()+2*60*60*1e3).toISOString(),eventDeleteDate:new Date(Date.now()+30*24*60*60*1e3).toISOString(),platform:"web",notificationType:"custom",customTitle:"Test Push Notification",customBody:"This is a test notification from the admin dashboard",headerImage:"",qrCodeImage:"",deepLinkType:"event",eventCode:"",eventPass:"",preferences:{upcomingEvent:!0,eventStarting:!0,uploadReminder:!0,downloadReminder:!0}}),{toast:l}=X(),{sendTestNotification:p,isLoading:L}=ye();v.useEffect(()=>{w(),S()},[]);const w=async()=>{u(!0);try{const{data:s,error:m}=await g.from("user_fcm_tokens").select("*").order("created_at",{ascending:!1});if(m){console.error("Error fetching FCM tokens:",m),l({title:"Error",description:"Failed to fetch FCM tokens: "+m.message,variant:"destructive"});return}if(!s||s.length===0){x([]);return}const N=[...new Set(s.map(_=>_.user_id))],{data:k,error:q}=await g.from("users").select("user_id, email").in("user_id",N);q&&console.warn("Could not fetch user emails:",q);const Z=new Map((k||[]).map(_=>[_.user_id,_.email])),B=s.map(_=>({..._,user_email:Z.get(_.user_id)||"Unknown"}));x(B)}catch(s){console.error("Unexpected error:",s),l({title:"Error",description:s.message,variant:"destructive"})}finally{u(!1)}},S=async()=>{try{const{data:s,error:m}=await g.from("users").select("user_id").eq("email","mattspecker@gmail.com").single();if(m||!s){console.log("Could not find user mattspecker@gmail.com for events");return}const{data:N,error:k}=await g.from("events").select("event_id, name, start_time, end_time, created_at, status, header_image_url, qr_code_image_url").eq("owner_id",s.user_id).order("created_at",{ascending:!1}).limit(20);if(k){console.error("Failed to fetch events:",k);return}d(N||[])}catch(s){console.error("Error fetching events:",s)}},ae=async()=>{try{u(!0),console.log("ðŸ§¹ Starting invalid token cleanup");const{data:s,error:m}=await g.functions.invoke("cleanup-invalid-fcm-tokens",{method:"POST"});if(m){console.error("Error cleaning up tokens:",m),l({title:"Cleanup Failed",description:m.message,variant:"destructive"});return}console.log("âœ… Cleanup result:",s),l({title:"Cleanup Complete",description:`Removed ${s.deleted} invalid tokens`}),await w()}catch(s){console.error("Unexpected error during cleanup:",s),l({title:"Error",description:s.message,variant:"destructive"})}finally{u(!1)}},ne=async s=>{c(s);const m=y.find(N=>N.event_id===s);if(m){const{data:N,error:k}=await g.from("invite_links").select("link").eq("event_id",s).single();let q="",Z="";if(N&&!k){const B=N.link.match(/\/join\/([^\/\?]+)/);B&&(q=B[1]);const{data:_}=await g.from("events").select("passcode").eq("event_id",s).single();_!=null&&_.passcode&&(Z=_.passcode)}i({...t,eventId:m.event_id,eventName:m.name,eventStartTime:m.start_time,eventEndTime:m.end_time,eventDeleteDate:new Date(new Date(m.end_time).getTime()+30*24*60*60*1e3).toISOString(),headerImage:m.header_image_url||"",qrCodeImage:m.qr_code_image_url||"",eventCode:q,eventPass:Z})}},ie=async()=>{if(!h){l({title:"Error",description:"Please select an FCM token",variant:"destructive"});return}if(t.deepLinkType==="join"&&!t.eventCode){l({title:"Error",description:"This event has no invite link. Create one first.",variant:"destructive"});return}try{const s=await p(h,{eventId:t.eventId,eventName:t.eventName,eventStartTime:t.eventStartTime,eventEndTime:t.eventEndTime,eventDeleteDate:t.eventDeleteDate,platform:t.platform,deepLinkType:t.deepLinkType,eventCode:t.eventCode,eventPass:t.eventPass},t.customTitle,t.customBody,t.headerImage,t.qrCodeImage);s.success?l({title:"Success",description:"Test push notification sent successfully!"}):l({title:"Error",description:s.error||"Failed to send push notification",variant:"destructive"})}catch(s){l({title:"Error",description:s.message,variant:"destructive"})}};return e.jsx("div",{className:"space-y-6",children:e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsx(D,{children:"Push Notification Testing"}),e.jsx(U,{children:"Send test push notifications to any registered FCM token"})]}),e.jsxs(C,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"fcm-token",children:"FCM Token"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(F,{value:h,onValueChange:s=>{f(s);const m=a.find(N=>N.fcm_token===s);m&&(i(N=>({...N,platform:m.platform})),console.log("ðŸ“± Auto-synced platform to:",m.platform))},children:[e.jsx(M,{className:"flex-1",children:e.jsx(R,{placeholder:"Select an FCM token"})}),e.jsx(P,{children:a.map(s=>{const m=s.error_count===0,N=s.error_count>0&&s.error_count<5,k=s.error_count>=5;return e.jsx(j,{value:s.fcm_token,children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:s.user_email||"Unknown"}),e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsx("span",{children:s.platform}),s.device_id&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsx("span",{className:"text-xs",children:s.device_id.slice(0,8)})]}),e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsx("span",{className:"text-xs",children:new Date(s.created_at).toLocaleDateString()}),e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsxs("span",{className:"text-xs font-mono",children:["...",s.fcm_token.slice(-8)]}),m&&s.last_success_at&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsx("span",{className:"text-xs text-green-600",children:"âœ“ Healthy"})]}),N&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsxs("span",{className:"text-xs text-yellow-600",children:["âš  ",s.error_count," errors"]})]}),k&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-muted-foreground",children:"â€¢"}),e.jsx("span",{className:"text-xs text-red-600",children:"âœ— Invalid"})]})]})},s.id)})})]}),e.jsx(E,{variant:"outline",onClick:w,disabled:r,children:"Refresh"}),e.jsx(E,{variant:"destructive",onClick:ae,disabled:r,children:"Clean Up Invalid Tokens"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"event-select",children:"Select Event (Optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(F,{value:n,onValueChange:ne,children:[e.jsx(M,{className:"flex-1",children:e.jsx(R,{placeholder:"Select an event to auto-fill details"})}),e.jsx(P,{children:y.map(s=>e.jsxs(j,{value:s.event_id,children:[s.name," - ",s.status,"(",new Date(s.created_at).toLocaleDateString(),")"]},s.event_id))})]}),e.jsx(E,{variant:"outline",onClick:S,disabled:r,children:"Refresh"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecting an event will auto-fill the event details below for testing dynamic placeholders"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"eventId",children:"Event ID"}),e.jsx(T,{id:"eventId",value:t.eventId,onChange:s=>i({...t,eventId:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"eventName",children:"Event Name"}),e.jsx(T,{id:"eventName",value:t.eventName,onChange:s=>i({...t,eventName:s.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"eventStartTime",children:"Event Start Time"}),e.jsx(T,{id:"eventStartTime",type:"datetime-local",value:t.eventStartTime.slice(0,16),onChange:s=>i({...t,eventStartTime:new Date(s.target.value).toISOString()})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"eventEndTime",children:"Event End Time"}),e.jsx(T,{id:"eventEndTime",type:"datetime-local",value:t.eventEndTime.slice(0,16),onChange:s=>i({...t,eventEndTime:new Date(s.target.value).toISOString()})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"eventDeleteDate",children:"Event Delete Date"}),e.jsx(T,{id:"eventDeleteDate",type:"datetime-local",value:t.eventDeleteDate.slice(0,16),onChange:s=>i({...t,eventDeleteDate:new Date(s.target.value).toISOString()})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"platform",children:"Platform"}),e.jsxs(F,{value:t.platform,onValueChange:s=>i({...t,platform:s}),children:[e.jsx(M,{children:e.jsx(R,{})}),e.jsxs(P,{children:[e.jsx(j,{value:"web",children:"Web"}),e.jsx(j,{value:"ios",children:"iOS"}),e.jsx(j,{value:"android",children:"Android"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:"deepLink",className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Deep Link Destination"]}),e.jsxs(F,{value:t.deepLinkType,onValueChange:s=>i({...t,deepLinkType:s}),children:[e.jsx(M,{id:"deepLink",children:e.jsx(R,{})}),e.jsx(P,{children:te.map(s=>e.jsx(j,{value:s.value,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:s.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.description})]})},s.value))})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["When the user taps the notification, they'll be taken to: ",e.jsx("code",{className:"bg-muted px-1 py-0.5 rounded",children:t.deepLinkType==="join"&&t.eventCode?`photoshare://join/${t.eventCode}${t.eventPass?`/${t.eventPass}`:""}`:`photoshare://${t.deepLinkType}/...`})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Event Images"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"headerImage",className:"text-sm font-medium",children:"Header Image"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{id:"headerImage",placeholder:"Header image URL",value:t.headerImage,onChange:s=>i({...t,headerImage:s.target.value})}),t.headerImage&&e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.headerImage,alt:"Header preview",className:"w-full h-20 object-cover rounded border",onError:s=>{s.currentTarget.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIxIDlWN0E0IDQgMCAwIDAgMTcgM0g3QTQgNCAwIDAgMCAzIDdWMTdBNCA0IDAgMCAwIDcgMjFIOVwiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiLz4KPHBhdGggZD0iTTMgMTFMMTMgMUwyMyAxMSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4K"}}),e.jsx(E,{variant:"ghost",size:"sm",className:"absolute top-1 right-1 h-6 w-6 p-0 bg-black/50 hover:bg-black/70",onClick:()=>i({...t,headerImage:""}),children:"Ã—"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"qrCodeImage",className:"text-sm font-medium",children:"QR Code Image"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{id:"qrCodeImage",placeholder:"QR code image URL",value:t.qrCodeImage,onChange:s=>i({...t,qrCodeImage:s.target.value})}),t.qrCodeImage&&e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.qrCodeImage,alt:"QR code preview",className:"w-full h-20 object-cover rounded border",onError:s=>{s.currentTarget.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iY3VycmVudENvbG9yIi8+CjxyZWN0IHg9IjE2IiB5PSIzIiB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSJjdXJyZW50Q29sb3IiLz4KPHJlY3QgeD0iMyIgeT0iMTYiIHdpZHRoPSI1IiBoZWlnaHQ9IjUiIGZpbGw9ImN1cnJlbnRDb2xvciIvPgo8L3N2Zz4K"}}),e.jsx(E,{variant:"ghost",size:"sm",className:"absolute top-1 right-1 h-6 w-6 p-0 bg-black/50 hover:bg-black/70",onClick:()=>i({...t,qrCodeImage:""}),children:"Ã—"})]})]})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Priority: Header image will be used if both are provided. Images should be publicly accessible URLs."})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"notificationType",children:"Notification Type"}),e.jsxs(F,{value:t.notificationType,onValueChange:s=>i({...t,notificationType:s}),children:[e.jsx(M,{children:e.jsx(R,{})}),e.jsxs(P,{children:[e.jsx(j,{value:"upcoming_event",children:"Upcoming Event"}),e.jsx(j,{value:"event_starting",children:"Event Starting"}),e.jsx(j,{value:"upload_reminder",children:"Upload Reminder"}),e.jsx(j,{value:"download_reminder",children:"Download Reminder"}),e.jsx(j,{value:"custom",children:"Custom"})]})]})]}),t.notificationType==="custom"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"customTitle",children:"Custom Title"}),e.jsx(T,{id:"customTitle",value:t.customTitle,onChange:s=>i({...t,customTitle:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"customBody",children:"Custom Body"}),e.jsx(Y,{id:"customBody",value:t.customBody,onChange:s=>i({...t,customBody:s.target.value})})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(D,{className:"text-sm",children:"User Preferences (for reference)"})}),e.jsxs(C,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(o,{htmlFor:"upcomingEvent",children:"Upcoming Event"}),e.jsx(H,{id:"upcomingEvent",checked:t.preferences.upcomingEvent,onCheckedChange:s=>i({...t,preferences:{...t.preferences,upcomingEvent:s}})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(o,{htmlFor:"eventStarting",children:"Event Starting"}),e.jsx(H,{id:"eventStarting",checked:t.preferences.eventStarting,onCheckedChange:s=>i({...t,preferences:{...t.preferences,eventStarting:s}})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(o,{htmlFor:"uploadReminder",children:"Upload Reminder"}),e.jsx(H,{id:"uploadReminder",checked:t.preferences.uploadReminder,onCheckedChange:s=>i({...t,preferences:{...t.preferences,uploadReminder:s}})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(o,{htmlFor:"downloadReminder",children:"Download Reminder"}),e.jsx(H,{id:"downloadReminder",checked:t.preferences.downloadReminder,onCheckedChange:s=>i({...t,preferences:{...t.preferences,downloadReminder:s}})})]})]})]}),e.jsx(E,{onClick:ie,disabled:L||!h,className:"w-full",children:L?"Sending...":"Send Test Push Notification"})]})]})})},Te=()=>(console.log("ðŸš€ AdminDashboard component rendering"),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"safe-area-header sticky top-0 z-50 bg-card/95 backdrop-blur-sm border-b border-border",children:e.jsx("div",{className:"container mx-auto px-3 sm:px-4 py-3 sm:py-4",children:e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5 text-primary"}),e.jsx("h1",{className:"text-xl font-semibold",children:"Admin Dashboard"})]})})})}),e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-7xl",children:[e.jsx("div",{className:"flex items-center justify-between mb-8",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-foreground",children:"Push Notifications"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Manage automated Firebase push notification templates for all events"})]})}),e.jsxs(ce,{defaultValue:"notifications",className:"space-y-6",children:[e.jsxs(oe,{className:"grid w-full grid-cols-4 max-w-2xl",children:[e.jsxs(W,{value:"notifications",className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Templates"]}),e.jsxs(W,{value:"push-testing",className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Push Testing"]}),e.jsxs(W,{value:"analytics",className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Analytics"]}),e.jsxs(W,{value:"settings",className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4"}),"Settings"]})]}),e.jsx(O,{value:"notifications",className:"space-y-6",children:e.jsx(fe,{})}),e.jsx(O,{value:"push-testing",className:"space-y-6",children:e.jsx(_e,{})}),e.jsx(O,{value:"analytics",className:"space-y-6",children:e.jsx(Ne,{})}),e.jsx(O,{value:"settings",className:"space-y-6",children:e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsx(D,{children:"System Settings"}),e.jsx(U,{children:"Configure global settings for push notification templates"})]}),e.jsx(C,{children:e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Settings panel coming soon..."})})})]})})]})]})]}));export{Te as default};
