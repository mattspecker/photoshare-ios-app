import{aa as _e,ab as te,ac as Ne,ad as Se,u as Te,a as ye,b as Ce,w as we,x as Ee,r as o,j as e,ae as be,B as V,af as De,C as S,M as T,N as y,A as Pe,O as C,f as w,p as d,I as M,W as Ie,g as Me,X as Ae,Y as $e,Z as ze,$ as ke,a0 as E,ag as Ue,ah as Fe,V as Re,s as l}from"./index-DJafiPoS.js";import{E as Ve,T as qe}from"./EventCreationBranding-BLv5icVp.js";import{c as Le,v as Oe,a as He,b as Ye,d as Be,e as Ge}from"./validation-DjZNYcmo.js";function ae(t,n,v){if(typeof t=="string"&&!t.match(_e))return te(t,{...v,timeZone:n});t=te(t,v);const A=Ne(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()).getTime(),$=Se(n,new Date(A));return new Date(A+$)}const Je=()=>{var G;const{user:t}=Te(),{toast:n}=ye(),v=Ce(),{dbPlatform:A,isNative:$}=we(),{createEventNotificationSettings:se}=Ee(),re=((G=window.CapacitorPushNotifications)==null?void 0:G.getToken())||null,[q,ne]=o.useState(""),[L,ie]=o.useState(""),[z,oe]=o.useState(""),[b,O]=o.useState(""),[x,H]=o.useState(""),[D,k]=o.useState(""),[ce,f]=o.useState("1"),[le,de]=o.useState(!0),[Y,B]=o.useState(!1),[j,P]=o.useState(null),[_,me]=o.useState(),[N,ue]=o.useState(),he=()=>{const a=["AMAZING","EPIC","MAGICAL","SUNNY","GOLDEN","BRIGHT"],i=["PARTY","EVENT","CELEBRATION","GATHERING","MOMENTS","MEMORIES"],r=a[Math.floor(Math.random()*a.length)],c=i[Math.floor(Math.random()*i.length)],g=Math.floor(Math.random()*100);return`${r}${c}${g}`},U=()=>Math.floor(1e3+Math.random()*9e3).toString(),pe=()=>{try{return Intl.DateTimeFormat().resolvedOptions().timeZone||"America/New_York"}catch(a){return console.warn("Could not detect timezone:",a),"America/New_York"}};o.useEffect(()=>{(async()=>{if(t){H(pe()),k(U());try{const{data:i,error:r}=await l.rpc("get_user_current_subscription",{target_user_id:t.id});if(r)console.error("Error fetching user subscription:",r),P({tier_name:"free",photo_retention_days:1}),f("1");else if(i&&i.length>0){const c=i[0];P(c),c.tier_name==="unlimited"||!c.photo_retention_days?f("30"):f(c.photo_retention_days.toString())}else P({tier_name:"free",photo_retention_days:1}),f("1")}catch(i){console.error("Error initializing form:",i),P({tier_name:"free",photo_retention_days:1}),f("1")}}})()},[t]);const ve=async a=>{if(a.preventDefault(),!t){n({title:"Authentication required",description:"Please log in to create events.",variant:"destructive"});return}if(!Le("create_event",3,3e5)){n({title:"Too many attempts",description:"Please wait before creating another event.",variant:"destructive"});return}const i=Oe(q);if(!i.isValid){n({title:"Invalid event name",description:i.error,variant:"destructive"});return}const r=He(L);if(!r.isValid){n({title:"Invalid description",description:r.error,variant:"destructive"});return}const c=Ye(z,b);if(!c.isValid){n({title:"Invalid date/time",description:c.error,variant:"destructive"});return}const g=Ge(x);if(!g.isValid){n({title:"Invalid timezone",description:g.error,variant:"destructive"});return}if(!D){n({title:"Passcode required",description:"A passcode is required for all events for security.",variant:"destructive"});return}const I=Be(D);if(!I.isValid){n({title:"Invalid passcode",description:I.error,variant:"destructive"});return}B(!0);try{const m=he(),u=D||U(),xe=new Date(z),fe=new Date(b),Q=ae(xe,x),W=ae(fe,x);let Z=_,J=N;if(_&&_.includes("branding/temp/"))try{const s=_.split("/event-photos/")[1],p=`branding/${t.id}/header-${Date.now()}${s.split(".").pop()?"."+s.split(".").pop():""}`,{error:F}=await l.storage.from("event-photos").move(s,p);if(!F){const{data:{publicUrl:R}}=l.storage.from("event-photos").getPublicUrl(p);Z=R}}catch(s){console.error("Failed to move header image:",s)}if(N&&N.includes("branding/temp/"))try{const s=N.split("/event-photos/")[1],p=`branding/${t.id}/qr-${Date.now()}${s.split(".").pop()?"."+s.split(".").pop():""}`,{error:F}=await l.storage.from("event-photos").move(s,p);if(!F){const{data:{publicUrl:R}}=l.storage.from("event-photos").getPublicUrl(p);J=R}}catch(s){console.error("Failed to move QR code image:",s)}const{data:h,error:X}=await l.from("events").insert({name:i.sanitized,description:r.sanitized,start_time:Q.toISOString(),end_time:W.toISOString(),timezone:x,passcode:u,retention_days:parseInt(ce),owner_id:t.id,status:"upcoming",header_image_url:Z,qr_code_image_url:J}).select().single();if(X)throw X;const{error:K}=await l.from("event_settings").insert({event_id:h.event_id,custom_message:r.sanitized,privacy_setting:"private"});K&&console.error("Error creating event settings:",K);const je=`https://photo-share.app/join/${m}`,{error:ee}=await l.from("invite_links").insert({event_id:h.event_id,link:je});if(ee){console.error("Error creating invite link:",ee),n({title:"Warning: Event created but invite link failed",description:`Event code: ${m}${u?` | Passcode: ${u}`:""} - You may need to recreate the event.`,variant:"destructive"});return}n({title:"Event created successfully! ðŸŽ‰",description:`Event code: ${m}${u?` | Passcode: ${u}`:""}`});try{await l.from("event_participants").insert({event_id:h.event_id,user_id:t.id,roles:["organizer"]}),await l.from("user_event_notification_settings").insert({user_id:t.id,event_id:h.event_id,upcoming_event:!0,event_starting:!0,upload_reminder:!0,download_reminder:!0});const s=localStorage.getItem(`auto_upload_settings_${t.id}`);s&&JSON.parse(s).autoUploadEnabled&&await l.from("event_participants").update({auto_upload_enabled:!0,auto_upload_start_time:Q.toISOString(),auto_upload_end_time:W.toISOString()}).eq("event_id",h.event_id).eq("user_id",t.id),$&&re&&(console.log("ðŸ“± Setting up push notifications for event creator"),(await se(h.event_id,{upcomingEvent:!0,eventStarting:!0,uploadReminder:!0,downloadReminder:!0})).success&&console.log("âœ… Push notification settings created"))}catch(s){console.error("Failed to set default preferences for event creator:",s)}v(`/event/${h.event_id}`)}catch(m){console.error("Event creation failed:",m),n({title:"Creation failed",description:"Unable to create event. Please try again.",variant:"destructive"})}finally{B(!1)}},ge=a=>{if(oe(a),a&&!b){const i=new Date(a),r=new Date(i.getTime()+1*60*60*1e3),c=r.getFullYear(),g=String(r.getMonth()+1).padStart(2,"0"),I=String(r.getDate()).padStart(2,"0"),m=String(r.getHours()).padStart(2,"0"),u=String(r.getMinutes()).padStart(2,"0");O(`${c}-${g}-${I}T${m}:${u}`)}};return t?e.jsxs(be,{className:"pb-20",children:[e.jsx("div",{className:"sticky top-0 z-40 bg-background/80 backdrop-blur-md border-b border-border",children:e.jsx("div",{className:"container mx-auto px-4 py-3",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(V,{variant:"ghost",size:"sm",onClick:()=>v("/dashboard"),className:"gap-2",children:[e.jsx(De,{className:"w-4 h-4"}),"Back"]})})})}),e.jsx("div",{className:"container mx-auto px-4 pt-6 pb-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Create New Event"})}),e.jsx("div",{className:"container mx-auto px-4 pb-8 max-w-2xl",children:e.jsxs("form",{onSubmit:ve,className:"space-y-6",children:[e.jsxs(S,{children:[e.jsxs(T,{children:[e.jsxs(y,{className:"flex items-center space-x-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),e.jsx("span",{children:"Event Details"})]}),e.jsx(C,{children:"Basic information about your event"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"eventName",children:"Event Name *"}),e.jsx(M,{id:"eventName",value:q,onChange:a=>ne(a.target.value),placeholder:"Sarah's Wedding, Company Retreat...",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"description",children:"Description"}),e.jsx(Ie,{id:"description",value:L,onChange:a=>ie(a.target.value),placeholder:"A brief description...",rows:3})]})]})]}),e.jsxs(S,{children:[e.jsxs(T,{children:[e.jsxs(y,{className:"flex items-center space-x-2",children:[e.jsx(Me,{className:"h-5 w-5"}),e.jsx("span",{children:"Schedule"})]}),e.jsx(C,{children:"Set your event timeframe"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"startDateTime",children:"Start Date & Time *"}),e.jsx(M,{id:"startDateTime",type:"datetime-local",value:z,onChange:a=>ge(a.target.value),required:!0,className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"endDateTime",children:"End Date & Time *"}),e.jsx(M,{id:"endDateTime",type:"datetime-local",value:b,onChange:a=>O(a.target.value),required:!0,className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"timezone",children:"Timezone"}),e.jsxs(Ae,{value:x,onValueChange:H,children:[e.jsx($e,{id:"timezone",children:e.jsx(ze,{placeholder:"Select timezone"})}),e.jsxs(ke,{children:[e.jsx(E,{value:"America/New_York",children:"Eastern Time (EST/EDT)"}),e.jsx(E,{value:"America/Chicago",children:"Central Time (CST/CDT)"}),e.jsx(E,{value:"America/Denver",children:"Mountain Time (MST/MDT)"}),e.jsx(E,{value:"America/Los_Angeles",children:"Pacific Time (PST/PDT)"}),e.jsx(E,{value:"UTC",children:"UTC"})]})]})]})]})]}),e.jsxs(S,{children:[e.jsxs(T,{children:[e.jsxs(y,{className:"flex items-center space-x-2",children:[e.jsx(Ue,{className:"h-5 w-5"}),e.jsx("span",{children:"Event Branding (Optional)"})]}),e.jsx(C,{children:"Customize your event's appearance"})]}),e.jsx(w,{children:e.jsx(Ve,{headerImageUrl:_,qrCodeImageUrl:N,onHeaderImageChange:me,onQrCodeImageChange:ue})})]}),e.jsxs(S,{children:[e.jsxs(T,{children:[e.jsxs(y,{className:"flex items-center space-x-2",children:[e.jsx(Fe,{className:"h-5 w-5"}),e.jsx("span",{children:"Security & Access"})]}),e.jsx(C,{children:"Control who can join and how"})]}),e.jsx(w,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"passcode",children:"Event Passcode *"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"A passcode is required for all events to ensure security"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(M,{id:"passcode",value:D,onChange:a=>k(a.target.value),placeholder:"Enter a passcode",maxLength:8,required:!0}),e.jsx(V,{type:"button",variant:"outline",onClick:()=>k(U()),children:"Generate"})]})]})})]}),e.jsxs(S,{children:[e.jsxs(T,{children:[e.jsxs(y,{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"h-5 w-5"}),e.jsx("span",{children:"Content Settings"})]}),e.jsx(C,{children:"How long to keep photos and moderation"})]}),e.jsxs(w,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Photo Retention Period"}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg border",children:[e.jsx("div",{className:"text-sm font-medium",children:j?j.tier_name==="unlimited"?"30 days (Unlimited Tier)":j.tier_name==="monthly"?`${j.photo_retention_days||7} day${(j.photo_retention_days||7)>1?"s":""} (Monthly Tier)`:"1 day (Free Tier)":"Loading..."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Photos will be automatically deleted after this period based on your current subscription tier"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(d,{children:"Auto-Moderation"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Automatically filter inappropriate content"})]}),e.jsx(Re,{checked:le,onCheckedChange:de})]})]})]}),e.jsx(V,{type:"submit",size:"lg",className:"camera-button w-full h-14 text-base",disabled:Y,children:Y?"Creating Event...":"Create Event"})]})})]}):(v("/login"),null)};export{Je as default};
